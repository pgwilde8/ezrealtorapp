<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% if agent %}{{ agent.first_name }}'s Lead Dashboard{% else %}Realtor Dashboard{% endif %} - EZRealtor.app</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        [x-cloak] { display: none !important; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen" x-data="realtorDashboard()" x-cloak>
    <!-- Top Navigation -->
    <nav class="bg-white shadow-lg border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center">
                    <h1 class="text-2xl font-bold text-blue-600">
                        <i class="fas fa-home mr-2"></i>EZRealtor.app
                    </h1>
                    {% if agent %}
                    <span class="ml-4 px-3 py-1 bg-blue-100 text-blue-800 text-sm font-medium rounded-full">
                        {{ agent.first_name }}'s Dashboard
                    </span>
                    {% endif %}
                </div>
                <div class="flex items-center space-x-4">
                    <div class="text-sm text-gray-500">
                        <i class="fas fa-crown text-yellow-500 mr-1"></i>
                        <span class="font-medium">{% if agent %}{{ agent.plan_tier|title }}{% else %}Trial{% endif %} Plan</span>
                    </div>
                    <button @click="refreshData" class="bg-blue-600 text-white px-3 py-1 rounded-md text-sm hover:bg-blue-700">
                        <i class="fas fa-sync-alt mr-1"></i> Refresh
                    </button>
                    <div class="relative" x-data="{ open: false }">
                        <button @click="open = !open" class="flex items-center text-gray-700 hover:text-gray-900">
                            <i class="fas fa-user-circle text-2xl mr-2"></i>
                            <i class="fas fa-chevron-down text-sm"></i>
                        </button>
                        <div x-show="open" @click.away="open = false" class="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-50">
                            <a href="/customize" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                <i class="fas fa-palette mr-2"></i>Customize Site
                            </a>
                            <a href="/billing" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                <i class="fas fa-credit-card mr-2"></i>Billing
                            </a>
                            <a href="/config" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                <i class="fas fa-cog mr-2"></i>Settings
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Welcome Banner for New Users -->
    {% if is_new_customer %}
    <div class="bg-gradient-to-r from-green-500 to-blue-600 text-white">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <div class="flex items-center">
                <i class="fas fa-party-horn text-2xl mr-3"></i>
                <div>
                    <h2 class="text-lg font-bold">Welcome to EZRealtor.app!</h2>
                    <p class="text-sm opacity-90">Your AI-powered lead generation system is ready. Start capturing leads now!</p>
                </div>
                <a href="/customize" class="ml-auto bg-white text-blue-600 px-4 py-2 rounded-md font-medium hover:bg-gray-100">
                    Customize Your Site
                </a>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Main Dashboard Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <!-- New User Explainer Banner (shows when zero leads) -->
        <div x-data="{ showBanner: true }" 
             x-show="(stats.totalLeads === 0 || stats.totalLeads === '0') && showBanner"
             class="bg-gradient-to-r from-blue-50 to-indigo-50 border-2 border-blue-200 rounded-lg p-5 mb-6 shadow-sm">
            <div class="flex items-start">
                <div class="flex-shrink-0">
                    <i class="fas fa-info-circle text-blue-600 text-2xl mt-1"></i>
                </div>
                <div class="ml-4 flex-1">
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">
                        👋 Welcome to Your Dashboard!
                    </h3>
                    <p class="text-gray-700 mb-3">
                        The metrics you see below are <strong>preview placeholders</strong> to show you what your dashboard will look like. 
                        Once you receive your <strong>first real lead</strong>, these will automatically update with your actual data.
                    </p>
                    <div class="bg-white rounded-lg p-3 border border-blue-200">
                        <p class="text-sm text-gray-600 mb-2"><strong>🚀 Get started:</strong></p>
                        <ol class="text-sm text-gray-700 space-y-1 ml-4">
                            <li>1. <a href="/customize" class="text-blue-600 hover:underline font-medium">Customize your website</a> with your branding</li>
                            <li>2. Share your lead capture pages (see below)</li>
                            <li>3. Watch your real leads come in!</li>
                        </ol>
                    </div>
                </div>
                <button @click="showBanner = false" class="flex-shrink-0 ml-4 text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
        </div>
        
        <!-- Key Metrics Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <!-- Total Leads -->
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center">
                    <div class="p-3 bg-blue-100 rounded-lg">
                        <i class="fas fa-users text-blue-600 text-xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Total Leads</p>
                        <p class="text-2xl font-bold text-gray-900" x-text="stats.totalLeads || '0'"></p>
                    </div>
                </div>
                <div class="mt-4">
                    <span class="text-blue-600 text-sm">
                        +<span x-text="stats.newLeadsToday || '0'"></span> today
                    </span>
                </div>
            </div>

            <!-- Hot Leads -->
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center">
                    <div class="p-3 bg-red-100 rounded-lg">
                        <i class="fas fa-fire text-red-600 text-xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Hot Leads</p>
                        <p class="text-2xl font-bold text-gray-900" x-text="stats.hotLeads || '0'"></p>
                    </div>
                </div>
                <div class="mt-4">
                    <span class="text-red-600 text-sm">
                        <span x-text="stats.hotLeadsPercentage || '0'"></span>% of total
                    </span>
                </div>
            </div>

            <!-- AI Insights -->
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center">
                    <div class="p-3 bg-purple-100 rounded-lg">
                        <i class="fas fa-robot text-purple-600 text-xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">AI Analyzed</p>
                        <p class="text-2xl font-bold text-gray-900" x-text="stats.aiAnalyzed || '0'"></p>
                    </div>
                </div>
                <div class="mt-4">
                    <span class="text-purple-600 text-sm">
                        <span x-text="stats.aiSuccessRate || '0'"></span>% success rate
                    </span>
                </div>
            </div>

            <!-- Conversion Rate -->
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center">
                    <div class="p-3 bg-green-100 rounded-lg">
                        <i class="fas fa-chart-line text-green-600 text-xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Conversion Rate</p>
                        <p class="text-2xl font-bold text-gray-900"><span x-text="stats.conversionRate || '0'"></span>%</p>
                    </div>
                </div>
                <div class="mt-4">
                    <span class="text-green-600 text-sm">
                        +<span x-text="stats.conversionImprovement || '0'"></span>% this month
                    </span>
                </div>
            </div>
        </div>

        <!-- Your Personal Website Section -->
        <div class="bg-gradient-to-r from-purple-600 to-indigo-600 rounded-lg shadow-lg p-6 mb-6">
            <div class="flex flex-wrap items-center justify-between gap-4">
                <div class="text-white">
                    <h3 class="text-xl font-bold mb-1">🌐 Your Personal Website</h3>
                    <p class="text-purple-100 text-sm mb-2">Your professional landing page</p>
                    <p class="text-white font-mono text-sm bg-white/20 px-3 py-1 rounded inline-block">
                        https://{{ agent.slug if agent else 'yourname' }}.ezrealtor.app
                    </p>
                </div>
                <div class="flex flex-wrap gap-3">
                    <a href="/" target="_blank" class="bg-white text-purple-700 px-5 py-2.5 rounded-md hover:bg-purple-50 flex items-center font-semibold">
                        <i class="fas fa-eye mr-2"></i>
                        View Your Site
                    </a>
                    <a href="/customize" class="bg-purple-800 text-white px-5 py-2.5 rounded-md hover:bg-purple-900 flex items-center font-semibold">
                        <i class="fas fa-palette mr-2"></i>
                        Customize
                    </a>
                </div>
            </div>
        </div>

        <!-- Phone Number Management Section -->
        {% include 'components/phone_number_manager.html' %}

        <!-- Custom Domain Section -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <div class="mb-4">
                <h3 class="text-lg font-semibold text-gray-900">🌍 Custom Domain</h3>
                <p class="text-sm text-gray-600">Use your own domain name instead of {{ agent.slug if agent else 'yourname' }}.ezrealtor.app</p>
            </div>

            {% if agent and agent.plan_tier in ['growth', 'scale', 'pro'] %}
            <!-- Has access to custom domains -->
            <div id="customDomainSection">
                <!-- No domain configured -->
                <div id="noDomain" style="display: block;">
                    <div style="background: #f0f9ff; border: 2px dashed #3b82f6; border-radius: 12px; padding: 25px; text-align: center;">
                        <p style="color: #1e40af; font-size: 15px; margin-bottom: 20px;">
                            ✨ Use your own domain to strengthen your brand!<br>
                            <span style="font-size: 13px; color: #6b7280;">Example: www.johnsmithrealty.com instead of {{ agent.slug if agent else 'yourname' }}.ezrealtor.app</span>
                        </p>
                        <button onclick="document.getElementById('addDomainModal').style.display='flex'" class="bg-blue-600 text-white px-6 py-3 rounded-md hover:bg-blue-700 font-semibold">
                            <i class="fas fa-plus-circle mr-2"></i>
                            Add Custom Domain
                        </button>
                    </div>
                </div>

                <!-- Domain configured (hidden by default) -->
                <div id="hasDomain" style="display: none;">
                    <div style="background: #ecfdf5; border: 2px solid #10b981; border-radius: 12px; padding: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <div>
                                <div style="font-size: 18px; font-weight: 600; color: #059669;" id="domainName">
                                    www.yourdom domain.com
                                </div>
                                <div style="font-size: 13px; color: #6b7280; margin-top: 3px;">
                                    Status: <span id="domainStatus" style="font-weight: 600; color: #10b981;">✅ Active</span>
                                </div>
                            </div>
                            <button onclick="removeDomain()" class="bg-red-100 text-red-700 px-4 py-2 rounded-md hover:bg-red-200 text-sm font-semibold">
                                Remove
                            </button>
                        </div>
                        <p style="font-size: 14px; color: #047857;">
                            Your custom domain is active and serving your pages!
                        </p>
                    </div>
                </div>
            </div>
            {% else %}
            <!-- Needs to upgrade -->
            <div style="background: linear-gradient(135deg, #fbbf24, #f59e0b); border-radius: 12px; padding: 25px; text-align: center; color: white;">
                <h4 style="font-size: 20px; font-weight: 700; margin-bottom: 10px;">💎 Premium Feature</h4>
                <p style="font-size: 15px; margin-bottom: 20px; opacity: 0.95;">
                    Custom domains are available on Growth plans and higher
                </p>
                <a href="/billing" class="bg-white text-orange-700 px-6 py-3 rounded-md hover:bg-orange-50 inline-block font-semibold" style="text-decoration: none;">
                    Upgrade to Growth - $147/mo
                </a>
            </div>
            {% endif %}
        </div>

        <!-- Send Property Alert Section -->
        <div class="bg-gradient-to-r from-orange-500 to-red-500 rounded-lg shadow-lg p-6 mb-6">
            <div class="flex flex-wrap items-center justify-between gap-4">
                <div class="text-white">
                    <h3 class="text-xl font-bold mb-1">🔥 Send Property Alert</h3>
                    <p class="text-orange-100 text-sm">Alert your subscribers about hot properties</p>
                </div>
                <button onclick="document.getElementById('alertModal').style.display='flex'" class="bg-white text-orange-700 px-6 py-3 rounded-md hover:bg-orange-50 flex items-center font-semibold">
                    <i class="fas fa-plus-circle mr-2"></i>
                    Create New Alert
                </button>
            </div>
        </div>

        <!-- Your Lead Capture Pages Section -->
        <div class="bg-white rounded-lg shadow p-6 mb-8">
            <div class="mb-4">
                <h3 class="text-lg font-semibold text-gray-900">📋 Your Lead Capture Pages</h3>
                <p class="text-sm text-gray-600">Share these pages to generate buyer and seller leads</p>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <div class="border-2 border-gray-200 rounded-lg p-4 hover:border-orange-500 transition-colors">
                    <div class="flex items-center mb-2">
                        <i class="fas fa-bell text-orange-600 text-xl mr-2"></i>
                        <h4 class="font-semibold text-gray-900">Listing Alerts</h4>
                    </div>
                    <p class="text-xs text-gray-600 mb-3">Simple email signup</p>
                    <a href="/listing-alerts" target="_blank" class="block text-center bg-orange-600 text-white px-3 py-2 rounded-md hover:bg-orange-700 text-sm">
                        <i class="fas fa-external-link-alt mr-1"></i> View Page
                    </a>
                </div>
                
                <div class="border-2 border-gray-200 rounded-lg p-4 hover:border-blue-500 transition-colors">
                    <div class="flex items-center mb-2">
                        <i class="fas fa-search-dollar text-blue-600 text-xl mr-2"></i>
                        <h4 class="font-semibold text-gray-900">Home Value</h4>
                    </div>
                    <p class="text-xs text-gray-600 mb-3">Capture seller leads</p>
                    <a href="/lead-home-value" target="_blank" class="block text-center bg-blue-600 text-white px-3 py-2 rounded-md hover:bg-blue-700 text-sm">
                        <i class="fas fa-external-link-alt mr-1"></i> View Page
                    </a>
                </div>
                
                <div class="border-2 border-gray-200 rounded-lg p-4 hover:border-green-500 transition-colors">
                    <div class="flex items-center mb-2">
                        <i class="fas fa-home text-green-600 text-xl mr-2"></i>
                        <h4 class="font-semibold text-gray-900">Find Homes</h4>
                    </div>
                    <p class="text-xs text-gray-600 mb-3">Capture buyer leads</p>
                    <a href="/lead-buyer" target="_blank" class="block text-center bg-green-600 text-white px-3 py-2 rounded-md hover:bg-green-700 text-sm">
                        <i class="fas fa-external-link-alt mr-1"></i> View Page
                    </a>
                </div>
                
                <div class="border-2 border-gray-200 rounded-lg p-4 hover:border-purple-500 transition-colors">
                    <div class="flex items-center mb-2">
                        <i class="fas fa-calculator text-purple-600 text-xl mr-2"></i>
                        <h4 class="font-semibold text-gray-900">Mortgage Calculator</h4>
                    </div>
                    <p class="text-xs text-gray-600 mb-3">Payment estimator</p>
                    <a href="/whats-my-rate" target="_blank" class="block text-center bg-purple-600 text-white px-3 py-2 rounded-md hover:bg-purple-700 text-sm">
                        <i class="fas fa-external-link-alt mr-1"></i> View Page
                    </a>
                </div>
            </div>
        </div>

        <!-- Leads Management Section -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
            
            <!-- Recent Leads -->
            <div class="lg:col-span-2 bg-white rounded-lg shadow">
                <div class="p-6 border-b border-gray-200 flex justify-between items-center">
                    <div>
                        <h3 class="text-lg font-semibold text-gray-900">Recent Leads</h3>
                        <p class="text-sm text-gray-600">Latest leads with AI insights</p>
                    </div>
                    <div class="flex space-x-2">
                        <button @click="filterLeads = 'all'" :class="filterLeads === 'all' ? 'bg-blue-100 text-blue-700' : 'text-gray-500 hover:text-gray-700'" class="px-3 py-1 rounded-md text-sm">
                            All
                        </button>
                        <button @click="filterLeads = 'hot'" :class="filterLeads === 'hot' ? 'bg-red-100 text-red-700' : 'text-gray-500 hover:text-gray-700'" class="px-3 py-1 rounded-md text-sm">
                            Hot
                        </button>
                        <button @click="filterLeads = 'new'" :class="filterLeads === 'new' ? 'bg-green-100 text-green-700' : 'text-gray-500 hover:text-gray-700'" class="px-3 py-1 rounded-md text-sm">
                            New
                        </button>
                    </div>
                </div>
                <div class="divide-y divide-gray-200 max-h-96 overflow-y-auto">
                    <template x-for="lead in filteredLeads" :key="lead.id">
                        <div class="p-6 hover:bg-gray-50">
                            <div class="flex items-center justify-between">
                                <div class="flex-1">
                                    <div class="flex items-center">
                                        <h4 class="text-lg font-medium text-gray-900" x-text="lead.name"></h4>
                                        <span class="ml-3 px-2 py-1 text-xs rounded-full" 
                                              :class="lead.priority === 'hot' ? 'bg-red-100 text-red-800' : 
                                                     lead.priority === 'warm' ? 'bg-yellow-100 text-yellow-800' : 
                                                     'bg-gray-100 text-gray-800'" 
                                              x-text="lead.priority?.toUpperCase()"></span>
                                        <span class="ml-2 px-2 py-1 text-xs bg-blue-100 text-blue-800 rounded-full" x-text="lead.source"></span>
                                    </div>
                                    <div class="mt-1 flex items-center text-sm text-gray-600">
                                        <i class="fas fa-envelope mr-1"></i>
                                        <span x-text="lead.email"></span>
                                        <span class="mx-2">•</span>
                                        <i class="fas fa-clock mr-1"></i>
                                        <span x-text="lead.timeAgo"></span>
                                    </div>
                                    <div class="mt-2" x-show="lead.aiSummary">
                                        <p class="text-sm text-gray-700">
                                            <i class="fas fa-robot text-purple-500 mr-1"></i>
                                            <span x-text="lead.aiSummary"></span>
                                        </p>
                                    </div>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <div class="text-right">
                                        <div class="text-lg font-bold" :class="lead.aiScore >= 80 ? 'text-green-600' : lead.aiScore >= 60 ? 'text-yellow-600' : 'text-gray-600'">
                                            <span x-text="lead.aiScore || 'N/A'"></span><span x-show="lead.aiScore">/100</span>
                                        </div>
                                        <div class="text-xs text-gray-500">AI Score</div>
                                    </div>
                                    <div class="flex flex-col space-y-1">
                                        <button @click="callLead(lead)" class="bg-blue-600 text-white px-3 py-1 rounded text-xs hover:bg-blue-700">
                                            <i class="fas fa-phone mr-1"></i>Call
                                        </button>
                                        <button @click="emailLead(lead)" class="bg-green-600 text-white px-3 py-1 rounded text-xs hover:bg-green-700">
                                            <i class="fas fa-envelope mr-1"></i>Email
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </template>
                    
                    <!-- Empty State -->
                    <div x-show="filteredLeads.length === 0" class="p-8 text-center">
                        <i class="fas fa-inbox text-gray-400 text-4xl mb-4"></i>
                        <p class="text-gray-600">No leads found. Start by sharing your lead capture forms!</p>
                        <div class="mt-4 space-x-2">
                            <a href="/lead-buyer" target="_blank" class="text-blue-600 hover:text-blue-800">Buyer Interest Form</a>
                            <span class="text-gray-400">•</span>
                            <a href="/lead-home-value" target="_blank" class="text-blue-600 hover:text-blue-800">Home Valuation Form</a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- AI Insights Panel -->
            <div class="bg-white rounded-lg shadow">
                <div class="p-6 border-b border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-900">AI Insights</h3>
                    <p class="text-sm text-gray-600">Smart recommendations for your business</p>
                </div>
                <div class="p-6">
                    <div class="space-y-4">
                        <template x-for="insight in aiInsights" :key="insight.id">
                            <div class="p-4 rounded-lg border border-gray-200">
                                <div class="flex items-start">
                                    <div class="flex-shrink-0">
                                        <i :class="insight.icon" class="text-purple-600 text-lg"></i>
                                    </div>
                                    <div class="ml-3">
                                        <h4 class="text-sm font-medium text-gray-900" x-text="insight.title"></h4>
                                        <p class="text-sm text-gray-600 mt-1" x-text="insight.description"></p>
                                        <button x-show="insight.action" class="text-blue-600 hover:text-blue-800 text-xs mt-2" x-text="insight.action"></button>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </div>

        <!-- Analytics Chart -->
        <div class="bg-white rounded-lg shadow mb-8">
            <div class="p-6 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-gray-900">Lead Analytics</h3>
                <p class="text-sm text-gray-600">Track your lead generation performance</p>
            </div>
            <div class="p-6">
                <canvas id="leadsChart" width="400" height="150"></canvas>
            </div>
        </div>

        <!-- Lead URLs Section -->
        <div class="bg-white rounded-lg shadow">
            <div class="p-6 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-gray-900">Your Lead Capture URLs</h3>
                <p class="text-sm text-gray-600">Share these links to start capturing leads</p>
            </div>
            <div class="p-6">
                {% if agent %}
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Buyer Interest Form:</label>
                        <div class="flex">
                            <input type="text" class="flex-1 px-3 py-2 border border-gray-300 rounded-l-md focus:outline-none focus:ring-2 focus:ring-blue-500" 
                                   value="https://{{ agent.slug }}.ezrealtor.app/lead-buyer" readonly>
                            <button onclick="copyToClipboard('https://{{ agent.slug }}.ezrealtor.app/lead-buyer')" 
                                    class="px-4 py-2 bg-blue-600 text-white rounded-r-md hover:bg-blue-700">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Home Valuation Form:</label>
                        <div class="flex">
                            <input type="text" class="flex-1 px-3 py-2 border border-gray-300 rounded-l-md focus:outline-none focus:ring-2 focus:ring-blue-500" 
                                   value="https://{{ agent.slug }}.ezrealtor.app/lead-home-value" readonly>
                            <button onclick="copyToClipboard('https://{{ agent.slug }}.ezrealtor.app/lead-home-value')" 
                                    class="px-4 py-2 bg-green-600 text-white rounded-r-md hover:bg-green-700">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        function realtorDashboard() {
            return {
                filterLeads: 'all',
                stats: {
                    totalLeads: 0,
                    newLeadsToday: 0,
                    hotLeads: 0,
                    hotLeadsPercentage: 0,
                    aiAnalyzed: 0,
                    aiSuccessRate: 0,
                    conversionRate: 0,
                    conversionImprovement: 0
                },
                leads: [],
                aiInsights: [
                    {
                        id: 1,
                        icon: 'fas fa-lightbulb',
                        title: 'Peak Lead Times',
                        description: 'Most leads come in between 2-4 PM on weekdays. Consider boosting ads during these hours.',
                        action: 'View Analytics'
                    },
                    {
                        id: 2,
                        icon: 'fas fa-target',
                        title: 'High-Intent Keywords',
                        description: 'Leads mentioning "urgent" or "relocating" have 85% higher conversion rates.',
                        action: 'Update Forms'
                    },
                    {
                        id: 3,
                        icon: 'fas fa-phone',
                        title: 'Response Time Impact',
                        description: 'Calling within 5 minutes increases conversion by 400%. Enable instant notifications.',
                        action: 'Configure Alerts'
                    }
                ],

                get filteredLeads() {
                    if (this.filterLeads === 'all') return this.leads;
                    if (this.filterLeads === 'hot') return this.leads.filter(lead => lead.priority === 'hot');
                    if (this.filterLeads === 'new') return this.leads.filter(lead => lead.isNew);
                    return this.leads;
                },

                async init() {
                    await this.loadDashboardData();
                    this.initChart();
                    
                    // Auto-refresh every 2 minutes
                    setInterval(() => {
                        this.refreshData();
                    }, 120000);
                },

                async loadDashboardData() {
                    try {
                        // Load agent stats
                        const statsResponse = await fetch('/api/v1/agents/stats');
                        if (statsResponse.ok) {
                            const statsData = await statsResponse.json();
                            this.stats = { ...this.stats, ...statsData };
                        }

                        // Load recent leads
                        const leadsResponse = await fetch('/api/v1/leads?limit=10');
                        if (leadsResponse.ok) {
                            const leadsData = await leadsResponse.json();
                            this.leads = leadsData.map(lead => ({
                                id: lead.id,
                                name: lead.full_name || 'Anonymous',
                                email: lead.email || 'No email',
                                source: lead.source || 'Unknown',
                                priority: lead.ai_priority || 'warm',
                                aiScore: lead.ai_score,
                                aiSummary: lead.ai_summary ? JSON.parse(lead.ai_summary).summary : null,
                                timeAgo: this.timeAgo(lead.created_at),
                                isNew: new Date(lead.created_at) > new Date(Date.now() - 24*60*60*1000)
                            }));
                        }

                        // Mock data if no real data
                        if (this.leads.length === 0) {
                            this.leads = [
                                {
                                    id: '1',
                                    name: 'Sarah Johnson',
                                    email: 'sarah@email.com',
                                    source: 'Buyer Interest',
                                    priority: 'hot',
                                    aiScore: 92,
                                    aiSummary: 'High-intent buyer looking for family home in Westfield. Has pre-approval, wants to move within 30 days.',
                                    timeAgo: '5 minutes ago',
                                    isNew: true
                                },
                                {
                                    id: '2',
                                    name: 'Mike Chen',
                                    email: 'mike@email.com',
                                    source: 'Home Valuation',
                                    priority: 'warm',
                                    aiScore: 76,
                                    aiSummary: 'Considering selling current home. Mentioned job relocation to Austin in 6 months.',
                                    timeAgo: '2 hours ago',
                                    isNew: false
                                },
                                {
                                    id: '3',
                                    name: 'Lisa Rodriguez',
                                    email: 'lisa@email.com',
                                    source: 'Buyer Interest',
                                    priority: 'cold',
                                    aiScore: 45,
                                    aiSummary: 'General inquiry about market conditions. No specific timeline mentioned.',
                                    timeAgo: '1 day ago',
                                    isNew: false
                                }
                            ];
                            
                            this.stats = {
                                totalLeads: 23,
                                newLeadsToday: 3,
                                hotLeads: 8,
                                hotLeadsPercentage: 35,
                                aiAnalyzed: 20,
                                aiSuccessRate: 87,
                                conversionRate: 24,
                                conversionImprovement: 12
                            };
                        }

                    } catch (error) {
                        console.error('Failed to load dashboard data:', error);
                    }
                },

                async refreshData() {
                    await this.loadDashboardData();
                },

                timeAgo(dateString) {
                    const date = new Date(dateString);
                    const now = new Date();
                    const diffMs = now - date;
                    const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
                    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
                    
                    if (diffHours < 1) return 'Just now';
                    if (diffHours < 24) return `${diffHours} hours ago`;
                    if (diffDays === 1) return 'Yesterday';
                    return `${diffDays} days ago`;
                },

                callLead(lead) {
                    // Open phone dialer if on mobile, or show phone number
                    if (lead.phone) {
                        window.open(`tel:${lead.phone}`);
                    } else {
                        alert(`Contact info: ${lead.email}`);
                    }
                },

                emailLead(lead) {
                    // Open email client
                    window.open(`mailto:${lead.email}?subject=Following up on your interest&body=Hi ${lead.name},%0D%0A%0D%0AI wanted to follow up on your recent inquiry...`);
                },

                initChart() {
                    const ctx = document.getElementById('leadsChart').getContext('2d');
                    new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                            datasets: [{
                                label: 'Leads',
                                data: [3, 7, 2, 8, 12, 5, 9],
                                borderColor: 'rgb(59, 130, 246)',
                                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                tension: 0.4,
                                fill: true
                            }, {
                                label: 'Hot Leads',
                                data: [1, 3, 1, 3, 5, 2, 4],
                                borderColor: 'rgb(239, 68, 68)',
                                backgroundColor: 'rgba(239, 68, 68, 0.1)',
                                tension: 0.4,
                                fill: true
                            }]
                        },
                        options: {
                            responsive: true,
                            scales: {
                                y: {
                                    beginAtZero: true
                                }
                            },
                            plugins: {
                                legend: {
                                    position: 'top',
                                }
                            }
                        }
                    });
                }
            }
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(function() {
                // Show success notification
                const notification = document.createElement('div');
                notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
                notification.innerHTML = '<i class="fas fa-check mr-2"></i>URL copied to clipboard!';
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 3000);
            });
        }
    </script>

    <!-- Add Custom Domain Modal -->
    <div id="addDomainModal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; padding: 20px;">
        <div style="background: white; border-radius: 12px; max-width: 600px; width: 100%; padding: 30px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="font-size: 24px; font-weight: 700; color: #1a1a1a;">🌍 Add Custom Domain</h3>
                <button onclick="document.getElementById('addDomainModal').style.display='none'" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">×</button>
            </div>

            <form id="domainForm" onsubmit="addCustomDomain(event)">
                <div style="margin-bottom: 20px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #374151;">Your Domain Name</label>
                    <input type="text" id="customDomainInput" required placeholder="www.johnsmithrealty.com" style="width: 100%; padding: 14px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 16px;">
                    <p style="font-size: 13px; color: #6b7280; margin-top: 6px;">Enter the domain you own (e.g., yourname.com or www.yourname.com)</p>
                </div>

                <div id="dnsInstructions" style="display: none; background: #fef3c7; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h4 style="font-size: 16px; font-weight: 600; color: #92400e; margin-bottom: 15px;">📋 DNS Setup Instructions</h4>
                    <p style="font-size: 14px; color: #92400e; margin-bottom: 15px;">Add these 2 records to your domain's DNS settings (GoDaddy, Namecheap, etc.):</p>
                    
                    <div style="background: white; padding: 12px; border-radius: 6px; margin-bottom: 10px; font-family: monospace; font-size: 13px;">
                        <strong>Record 1:</strong> Point domain to EZRealtor<br>
                        Type: CNAME<br>
                        Name: <span id="dns1Name">@</span><br>
                        Value: ezrealtor.app<br>
                        TTL: Auto
                    </div>
                    
                    <div style="background: white; padding: 12px; border-radius: 6px; font-family: monospace; font-size: 13px;">
                        <strong>Record 2:</strong> Enable auto SSL renewal<br>
                        Type: CNAME<br>
                        Name: _acme-challenge<br>
                        Value: <span id="dns2Value">Loading...</span><br>
                        TTL: Auto
                    </div>

                    <p style="font-size: 13px; color: #92400e; margin-top: 15px;">
                        ⏱️ DNS changes can take 5-30 minutes to propagate.
                    </p>
                </div>

                <div id="verificationStatus" style="display: none; background: #dbeafe; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <p style="font-size: 14px; color: #1e40af; margin-bottom: 10px;">
                        <strong>🔄 Verifying your domain...</strong>
                    </p>
                    <p style="font-size: 13px; color: #1e3a8a;">
                        We're checking if the DNS records are configured correctly. This usually takes 5-30 minutes.
                    </p>
                    <button type="button" onclick="checkDomainStatus()" style="margin-top: 10px; padding: 8px 16px; background: #3b82f6; color: white; border: none; border-radius: 6px; font-size: 14px; cursor: pointer;">
                        Check Status Now
                    </button>
                </div>

                <div style="display: flex; gap: 10px;">
                    <button type="button" onclick="document.getElementById('addDomainModal').style.display='none'" style="flex: 1; padding: 14px; background: #e5e7eb; color: #374151; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                        Cancel
                    </button>
                    <button type="submit" id="addDomainBtn" style="flex: 2; padding: 14px; background: #3b82f6; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                        Add Domain
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Property Alert Modal -->
    <div id="alertModal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; padding: 20px;">
        <div style="background: white; border-radius: 12px; max-width: 600px; width: 100%; max-height: 90vh; overflow-y: auto; padding: 30px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="font-size: 24px; font-weight: 700; color: #1a1a1a;">🔥 Create Property Alert</h3>
                <button onclick="document.getElementById('alertModal').style.display='none'" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">×</button>
            </div>

            <form id="alertForm">
                <!-- Step 1: Property Details -->
                <div id="alertStep1" style="display: flex; flex-direction: column; gap: 20px;">
                    <div>
                        <label style="display: block; font-weight: 600; margin-bottom: 6px; color: #374151;">Property Address *</label>
                        <input type="text" id="alertAddress" required placeholder="123 Oak Street, City, State" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 15px;">
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <label style="display: block; font-weight: 600; margin-bottom: 6px; color: #374151;">Price *</label>
                            <input type="number" id="alertPrice" required placeholder="495000" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 15px;">
                        </div>
                        <div>
                            <label style="display: block; font-weight: 600; margin-bottom: 6px; color: #374151;">Square Feet</label>
                            <input type="number" id="alertSqft" placeholder="2400" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 15px;">
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <label style="display: block; font-weight: 600; margin-bottom: 6px; color: #374151;">Bedrooms *</label>
                            <select id="alertBedrooms" required style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 15px;">
                                <option value="">Select</option>
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                                <option value="5">5+</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; font-weight: 600; margin-bottom: 6px; color: #374151;">Bathrooms *</label>
                            <select id="alertBathrooms" required style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 15px;">
                                <option value="">Select</option>
                                <option value="1">1</option>
                                <option value="1.5">1.5</option>
                                <option value="2">2</option>
                                <option value="2.5">2.5</option>
                                <option value="3">3+</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <label style="display: block; font-weight: 600; margin-bottom: 6px; color: #374151;">Quick Description (for SMS/Email) *</label>
                        <textarea id="alertDescription" required rows="3" placeholder="Move-in ready! Updated kitchen, hardwood floors, great schools. Showing this weekend." style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 15px; resize: vertical;"></textarea>
                    </div>

                    <div>
                        <label style="display: block; font-weight: 600; margin-bottom: 6px; color: #374151;">MLS Link (Optional)</label>
                        <input type="url" id="alertLink" placeholder="https://..." style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 15px;">
                    </div>

                    <div style="background: #fef3c7; padding: 15px; border-radius: 8px; border-left: 4px solid #f59e0b;">
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                            <input type="checkbox" id="isHotProperty" style="width: 20px; height: 20px;">
                            <div>
                                <strong style="color: #92400e;">🔥 Mark as "Hot Property"</strong>
                                <p style="font-size: 13px; color: #92400e; margin: 0;">Send SMS to VIP subscribers immediately (email subscribers get it in 6 hours)</p>
                            </div>
                        </label>
                    </div>

                    <button type="button" onclick="goToStep2()" style="width: 100%; padding: 14px; background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 16px;">
                        Next: Add Photos →
                    </button>
                </div>

                <!-- Step 2: Photo Upload -->
                <div id="alertStep2" style="display: none; flex-direction: column; gap: 20px;">
                    <div style="text-align: center; padding: 10px 0;">
                        <span style="background: #e0e7ff; color: #4338ca; padding: 6px 12px; border-radius: 20px; font-size: 13px; font-weight: 600;">Step 2 of 2</span>
                    </div>

                    <div>
                        <label style="display: block; font-weight: 600; margin-bottom: 10px; color: #374151; font-size: 16px;">📸 Upload Property Photos</label>
                        <p style="font-size: 14px; color: #6b7280; margin-bottom: 15px;">Add 1-5 photos to make your alert stand out (optional but recommended)</p>
                        
                        <div id="photoUploadArea" style="border: 2px dashed #d1d5db; border-radius: 12px; padding: 30px; text-align: center; background: #f9fafb; cursor: pointer; transition: all 0.3s;" onclick="document.getElementById('photoInput').click()">
                            <i class="fas fa-cloud-upload-alt" style="font-size: 48px; color: #9ca3af; margin-bottom: 10px;"></i>
                            <p style="color: #6b7280; font-size: 15px; font-weight: 600; margin-bottom: 5px;">Click to upload photos</p>
                            <p style="color: #9ca3af; font-size: 13px;">or drag and drop</p>
                            <p style="color: #9ca3af; font-size: 12px; margin-top: 8px;">JPG, PNG up to 5MB each • Max 5 photos</p>
                        </div>
                        <input type="file" id="photoInput" accept="image/*" multiple style="display: none;" onchange="handlePhotoSelect(event)">
                    </div>

                    <div id="photoPreview" style="display: none; gap: 10px; flex-wrap: wrap;"></div>

                    <div id="matchPreview" style="background: #dbeafe; padding: 15px; border-radius: 8px;">
                        <h4 style="font-size: 14px; font-weight: 600; color: #1e40af; margin-bottom: 10px;">📊 Who Will Receive This Alert:</h4>
                        <p style="font-size: 14px; color: #1e3a8a; margin: 5px 0;">
                            <strong id="smsCount">0</strong> VIP SMS subscribers (instant text)
                        </p>
                        <p style="font-size: 14px; color: #1e3a8a; margin: 5px 0;">
                            <strong id="emailCount">0</strong> Email subscribers
                        </p>
                        <button type="button" onclick="previewMatches()" style="margin-top: 10px; padding: 8px 16px; background: #3b82f6; color: white; border: none; border-radius: 6px; font-size: 13px; cursor: pointer;">
                            🔄 Refresh Match Count
                        </button>
                    </div>

                    <div style="display: flex; gap: 10px;">
                        <button type="button" onclick="goToStep1()" style="flex: 1; padding: 14px; background: #6b7280; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                            ← Back
                        </button>
                        <button type="submit" id="sendAlertBtn" style="flex: 2; padding: 14px; background: linear-gradient(135deg, #f97316, #dc2626); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 16px;">
                            📨 Send Alert to Subscribers
                        </button>
                    </div>
                </div>
            </form>

            <div id="alertSuccess" style="display: none; text-align: center; padding: 30px;">
                <div style="font-size: 64px; margin-bottom: 20px;">✅</div>
                <h3 style="font-size: 24px; color: #059669; margin-bottom: 15px;">Alert Sent!</h3>
                <p style="color: #666; margin-bottom: 10px;">Your property alert has been sent to <strong id="totalSent">0</strong> subscribers.</p>
                <button onclick="resetAlertForm()" style="margin-top: 20px; padding: 12px 24px; background: #667eea; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                    Send Another Alert
                </button>
            </div>
        </div>
    </div>

    <script>
        let uploadedPhotos = [];
        
        function goToStep2() {
            // Validate Step 1 first
            if (!document.getElementById('alertAddress').value || 
                !document.getElementById('alertPrice').value ||
                !document.getElementById('alertBedrooms').value ||
                !document.getElementById('alertBathrooms').value ||
                !document.getElementById('alertDescription').value) {
                alert('Please fill in all required fields');
                return;
            }
            
            document.getElementById('alertStep1').style.display = 'none';
            document.getElementById('alertStep2').style.display = 'flex';
            
            // Auto-preview matches when going to step 2
            previewMatches();
        }
        
        function goToStep1() {
            document.getElementById('alertStep2').style.display = 'none';
            document.getElementById('alertStep1').style.display = 'flex';
        }
        
        function handlePhotoSelect(event) {
            const files = Array.from(event.target.files);
            
            // Limit to 5 photos
            if (uploadedPhotos.length + files.length > 5) {
                alert('Maximum 5 photos allowed');
                return;
            }
            
            // Validate file size (5MB max each)
            for (let file of files) {
                if (file.size > 5 * 1024 * 1024) {
                    alert(file.name + ' is too large. Maximum 5MB per photo.');
                    return;
                }
            }
            
            // Add to uploaded photos
            uploadedPhotos = uploadedPhotos.concat(files);
            
            // Show preview
            displayPhotoPreview();
        }
        
        function displayPhotoPreview() {
            const previewContainer = document.getElementById('photoPreview');
            
            if (uploadedPhotos.length === 0) {
                previewContainer.style.display = 'none';
                return;
            }
            
            previewContainer.style.display = 'flex';
            previewContainer.innerHTML = '';
            
            uploadedPhotos.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const photoCard = document.createElement('div');
                    photoCard.style.cssText = 'position: relative; width: 100px; height: 100px; border-radius: 8px; overflow: hidden; border: 2px solid #e5e7eb;';
                    photoCard.innerHTML = `
                        <img src="${e.target.result}" style="width: 100%; height: 100%; object-fit: cover;">
                        <button onclick="removePhoto(${index})" style="position: absolute; top: 5px; right: 5px; background: rgba(220, 38, 38, 0.9); color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; font-size: 14px; line-height: 1;">×</button>
                    `;
                    previewContainer.appendChild(photoCard);
                };
                reader.readAsDataURL(file);
            });
            
            // Update upload area text
            document.getElementById('photoUploadArea').innerHTML = `
                <i class="fas fa-check-circle" style="font-size: 36px; color: #10b981; margin-bottom: 10px;"></i>
                <p style="color: #059669; font-size: 15px; font-weight: 600;">${uploadedPhotos.length} photo${uploadedPhotos.length > 1 ? 's' : ''} selected</p>
                <p style="color: #6b7280; font-size: 13px; margin-top: 5px;">Click to add more (max 5 total)</p>
            `;
        }
        
        function removePhoto(index) {
            uploadedPhotos.splice(index, 1);
            displayPhotoPreview();
            
            if (uploadedPhotos.length === 0) {
                document.getElementById('photoUploadArea').innerHTML = `
                    <i class="fas fa-cloud-upload-alt" style="font-size: 48px; color: #9ca3af; margin-bottom: 10px;"></i>
                    <p style="color: #6b7280; font-size: 15px; font-weight: 600; margin-bottom: 5px;">Click to upload photos</p>
                    <p style="color: #9ca3af; font-size: 13px;">or drag and drop</p>
                    <p style="color: #9ca3af; font-size: 12px; margin-top: 8px;">JPG, PNG up to 5MB each • Max 5 photos</p>
                `;
            }
        }
        
        async function previewMatches() {
            const price = parseInt(document.getElementById('alertPrice').value) || 0;
            const bedrooms = document.getElementById('alertBedrooms').value;
            
            // TODO: Call API to get actual match count
            // For now, show dummy data
            document.getElementById('smsCount').textContent = '8';
            document.getElementById('emailCount').textContent = '23';
        }

        document.getElementById('alertForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const sendBtn = document.getElementById('sendAlertBtn');
            sendBtn.disabled = true;
            sendBtn.textContent = 'Uploading photos...';
            
            const alertData = {
                address: document.getElementById('alertAddress').value,
                price: parseFloat(document.getElementById('alertPrice').value),
                sqft: document.getElementById('alertSqft').value,
                bedrooms: parseInt(document.getElementById('alertBedrooms').value),
                bathrooms: parseFloat(document.getElementById('alertBathrooms').value),
                description: document.getElementById('alertDescription').value,
                link: document.getElementById('alertLink').value,
                is_hot_property: document.getElementById('isHotProperty').checked,
                photo_urls: []
            };
            
            try {
                // Upload photos first if any
                if (uploadedPhotos.length > 0) {
                    for (let i = 0; i < uploadedPhotos.length; i++) {
                        sendBtn.textContent = `Uploading photo ${i+1}/${uploadedPhotos.length}...`;
                        
                        const formData = new FormData();
                        formData.append('file', uploadedPhotos[i]);
                        formData.append('folder', 'property-alerts');
                        
                        const uploadResponse = await fetch('/api/v1/upload/image', {
                            method: 'POST',
                            headers: {
                                'Authorization': 'Bearer ' + localStorage.getItem('access_token')
                            },
                            body: formData
                        });
                        
                        if (uploadResponse.ok) {
                            const uploadResult = await uploadResponse.json();
                            alertData.photo_urls.push(uploadResult.url);
                        }
                    }
                }
                
                // Send alert with photos
                sendBtn.textContent = 'Sending alert...';
                
                const response = await fetch('/api/v1/property-alerts/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + localStorage.getItem('access_token')
                    },
                    body: JSON.stringify(alertData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    document.getElementById('alertStep1').style.display = 'none';
                    document.getElementById('alertStep2').style.display = 'none';
                    document.getElementById('alertSuccess').style.display = 'block';
                    document.getElementById('totalSent').textContent = result.total_sent || 0;
                } else {
                    alert('Error sending alert. Please try again.');
                    sendBtn.disabled = false;
                    sendBtn.textContent = '📨 Send Alert to Subscribers';
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Network error. Please try again.');
                sendBtn.disabled = false;
                sendBtn.textContent = '📨 Send Alert to Subscribers';
            }
        });

        function resetAlertForm() {
            document.getElementById('alertForm').reset();
            document.getElementById('alertStep1').style.display = 'flex';
            document.getElementById('alertStep2').style.display = 'none';
            document.getElementById('alertSuccess').style.display = 'none';
            document.getElementById('photoPreview').style.display = 'none';
            document.getElementById('alertModal').style.display = 'none';
            document.getElementById('sendAlertBtn').disabled = false;
            document.getElementById('sendAlertBtn').textContent = '📨 Send Alert to Subscribers';
            
            // Reset photos
            uploadedPhotos = [];
            document.getElementById('photoInput').value = '';
            document.getElementById('photoUploadArea').innerHTML = `
                <i class="fas fa-cloud-upload-alt" style="font-size: 48px; color: #9ca3af; margin-bottom: 10px;"></i>
                <p style="color: #6b7280; font-size: 15px; font-weight: 600; margin-bottom: 5px;">Click to upload photos</p>
                <p style="color: #9ca3af; font-size: 13px;">or drag and drop</p>
                <p style="color: #9ca3af; font-size: 12px; margin-top: 8px;">JPG, PNG up to 5MB each • Max 5 photos</p>
            `;
        }

        // Custom Domain Functions
        async function addCustomDomain(event) {
            event.preventDefault();
            
            const domainInput = document.getElementById('customDomainInput').value.trim().toLowerCase();
            const addBtn = document.getElementById('addDomainBtn');
            
            addBtn.disabled = true;
            addBtn.textContent = 'Adding domain...';
            
            try {
                const response = await fetch('/api/v1/domains/custom', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + localStorage.getItem('access_token')
                    },
                    body: JSON.stringify({
                        domain_name: domainInput
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    // Show DNS instructions
                    document.getElementById('dns1Name').textContent = result.dns_records[0].name;
                    document.getElementById('dns2Value').textContent = result.dns_records[1].value;
                    document.getElementById('dnsInstructions').style.display = 'block';
                    document.getElementById('verificationStatus').style.display = 'block';
                    addBtn.textContent = 'Domain Added - Awaiting DNS';
                    addBtn.disabled = true;
                    
                    // Start polling for verification
                    setTimeout(() => checkDomainStatus(), 30000); // Check in 30 seconds
                } else {
                    alert(result.detail || 'Error adding domain. Please try again.');
                    addBtn.disabled = false;
                    addBtn.textContent = 'Add Domain';
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Network error. Please try again.');
                addBtn.disabled = false;
                addBtn.textContent = 'Add Domain';
            }
        }

        async function checkDomainStatus() {
            try {
                const response = await fetch('/api/v1/domains/custom/status', {
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('access_token')
                    }
                });
                
                const result = await response.json();
                
                if (result.is_verified) {
                    // Domain verified!
                    document.getElementById('addDomainModal').style.display = 'none';
                    document.getElementById('noDomain').style.display = 'none';
                    document.getElementById('hasDomain').style.display = 'block';
                    document.getElementById('domainName').textContent = result.domain_name;
                    document.getElementById('domainStatus').innerHTML = '✅ Active';
                    
                    alert('🎉 Your custom domain is now active!');
                    location.reload(); // Refresh to update UI
                } else {
                    alert('Domain not verified yet. DNS records may need more time to propagate (5-30 minutes). Click "Check Status Now" again in a few minutes.');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error checking status. Please try again.');
            }
        }

        async function removeDomain() {
            if (!confirm('Are you sure you want to remove your custom domain? Your subdomain will still work.')) {
                return;
            }
            
            try {
                const response = await fetch('/api/v1/domains/custom', {
                    method: 'DELETE',
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('access_token')
                    }
                });
                
                if (response.ok) {
                    document.getElementById('hasDomain').style.display = 'none';
                    document.getElementById('noDomain').style.display = 'block';
                    alert('Custom domain removed successfully.');
                } else {
                    alert('Error removing domain. Please try again.');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Network error. Please try again.');
            }
        }

        // Check if agent has custom domain on page load
        window.addEventListener('DOMContentLoaded', async function() {
            try {
                const response = await fetch('/api/v1/domains/custom/status', {
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('access_token')
                    }
                });
                
                const result = await response.json();
                
                if (result.has_domain && result.is_verified) {
                    document.getElementById('noDomain').style.display = 'none';
                    document.getElementById('hasDomain').style.display = 'block';
                    document.getElementById('domainName').textContent = result.domain_name;
                }
            } catch (error) {
                // No domain configured or error - show default state
                console.log('No custom domain configured');
            }
        });
    </script>
</body>
</html>