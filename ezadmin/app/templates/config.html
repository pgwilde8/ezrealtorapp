<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Configuration | {{ agent_name if agent_name else 'EZRealtor' }}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900 mb-2">AI Configuration</h1>
            <p class="text-gray-600">Configure your API keys to enable AI-powered lead capture features</p>
        </div>

        <!-- Configuration Form -->
        <div class="max-w-4xl mx-auto bg-white rounded-lg shadow-lg p-8" x-data="configForm()">
            <form @submit.prevent="saveConfiguration()" class="space-y-8">
                
                <!-- OpenAI Configuration -->
                <div class="border-b pb-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                        <span class="w-3 h-3 bg-green-500 rounded-full mr-3"></span>
                        OpenAI API (Required for AI Features)
                    </h3>
                    <div class="grid md:grid-cols-2 gap-4">
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">OpenAI API Key</label>
                            <input type="password" x-model="config.OPENAI_API_KEY" 
                                   placeholder="sk-..."
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <p class="text-sm text-gray-500 mt-1">Required for AI lead insights and content generation</p>
                        </div>
                    </div>
                </div>

                <!-- Communication APIs -->
                <div class="border-b pb-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                        <span class="w-3 h-3 bg-blue-500 rounded-full mr-3"></span>
                        Communication APIs
                    </h3>
                    <div class="grid md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Twilio Account SID</label>
                            <input type="text" x-model="config.TWILIO_ACCOUNT_SID" 
                                   placeholder="AC..."
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Twilio Auth Token</label>
                            <input type="password" x-model="config.TWILIO_AUTH_TOKEN" 
                                   placeholder="Your auth token"
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Twilio Phone Number</label>
                            <input type="tel" x-model="config.TWILIO_PHONE_NUMBER" 
                                   placeholder="+1234567890"
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Your Phone (for alerts)</label>
                            <input type="tel" x-model="config.AGENT_PHONE_NUMBER" 
                                   placeholder="+1234567890"
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Brevo API Key</label>
                            <input type="password" x-model="config.BREVO_API_KEY" 
                                   placeholder="xkeysib-..."
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <p class="text-sm text-gray-500 mt-1">For email marketing and lead nurturing</p>
                        </div>
                    </div>
                </div>

                <!-- Location & Map APIs -->
                <div class="border-b pb-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                        <span class="w-3 h-3 bg-purple-500 rounded-full mr-3"></span>
                        Location & Mapping APIs
                    </h3>
                    <div class="grid md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Foursquare API Key</label>
                            <input type="password" x-model="config.FOURSQUARE_API_KEY" 
                                   placeholder="fsq3..."
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <p class="text-sm text-gray-500 mt-1">For neighborhood insights and local amenities</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">MapTiler API Key</label>
                            <input type="password" x-model="config.MAPTILER_KEY" 
                                   placeholder="Your MapTiler key"
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <p class="text-sm text-gray-500 mt-1">For interactive maps on lead capture forms</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">OpenRouteService API Key</label>
                            <input type="password" x-model="config.ORS_API_KEY" 
                                   placeholder="Your ORS key"
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <p class="text-sm text-gray-500 mt-1">For commute time calculations</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">USPS User ID</label>
                            <input type="text" x-model="config.USPS_USER_ID" 
                                   placeholder="Your USPS User ID"
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <p class="text-sm text-gray-500 mt-1">For address validation</p>
                        </div>
                    </div>
                </div>

                <!-- Google Integration -->
                <div class="border-b pb-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                        <span class="w-3 h-3 bg-red-500 rounded-full mr-3"></span>
                        Google Integration
                    </h3>
                    <div class="grid md:grid-cols-2 gap-4">
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Google OAuth Client ID</label>
                            <input type="text" x-model="config.GOOGLE_OAUTH_CLIENT_ID" 
                                   placeholder="Your Google OAuth Client ID"
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <p class="text-sm text-gray-500 mt-1">For Google Maps integration and authentication</p>
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Google OAuth Client Secret</label>
                            <input type="password" x-model="config.GOOGLE_OAUTH_CLIENT_SECRET" 
                                   placeholder="Your Google OAuth Client Secret"
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                    </div>
                </div>

                <!-- API Status -->
                <div class="bg-gray-50 p-6 rounded-lg">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">API Status</h3>
                    <div class="grid md:grid-cols-3 gap-4">
                        <div class="flex items-center">
                            <span :class="apiStatus.openai ? 'text-green-600' : 'text-red-600'" class="mr-2">●</span>
                            <span class="text-sm">OpenAI</span>
                        </div>
                        <div class="flex items-center">
                            <span :class="apiStatus.twilio ? 'text-green-600' : 'text-red-600'" class="mr-2">●</span>
                            <span class="text-sm">Twilio</span>
                        </div>
                        <div class="flex items-center">
                            <span :class="apiStatus.brevo ? 'text-green-600' : 'text-red-600'" class="mr-2">●</span>
                            <span class="text-sm">Brevo</span>
                        </div>
                        <div class="flex items-center">
                            <span :class="apiStatus.foursquare ? 'text-green-600' : 'text-red-600'" class="mr-2">●</span>
                            <span class="text-sm">Foursquare</span>
                        </div>
                        <div class="flex items-center">
                            <span :class="apiStatus.maptiler ? 'text-green-600' : 'text-red-600'" class="mr-2">●</span>
                            <span class="text-sm">MapTiler</span>
                        </div>
                        <div class="flex items-center">
                            <span :class="apiStatus.google ? 'text-green-600' : 'text-red-600'" class="mr-2">●</span>
                            <span class="text-sm">Google OAuth</span>
                        </div>
                    </div>
                    <button type="button" @click="testAPIs()" 
                            class="mt-4 px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">
                        Test API Connections
                    </button>
                </div>

                <!-- Save Button -->
                <div class="pt-6">
                    <button type="submit" 
                            :disabled="loading"
                            class="w-full bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white font-semibold py-3 px-6 rounded-lg transition duration-200">
                        <span x-show="!loading">Save Configuration</span>
                        <span x-show="loading">Saving...</span>
                    </button>
                </div>
            </form>

            <!-- Success Message -->
            <div x-show="success" class="mt-6 p-4 bg-green-100 border border-green-400 text-green-700 rounded-lg">
                <h4 class="font-semibold">Configuration Saved!</h4>
                <p>Your API keys have been securely encrypted and stored. AI features are now active.</p>
            </div>
        </div>

        <!-- Help Section -->
        <div class="max-w-4xl mx-auto mt-8 bg-blue-50 rounded-lg p-6">
            <h3 class="text-lg font-semibold text-blue-900 mb-4">Getting Your API Keys</h3>
            <div class="grid md:grid-cols-2 gap-4 text-sm text-blue-800">
                <div>
                    <h4 class="font-medium">OpenAI</h4>
                    <p>Visit <a href="https://platform.openai.com/api-keys" target="_blank" class="underline">platform.openai.com/api-keys</a></p>
                </div>
                <div>
                    <h4 class="font-medium">Twilio</h4>
                    <p>Visit <a href="https://console.twilio.com/" target="_blank" class="underline">console.twilio.com</a></p>
                </div>
                <div>
                    <h4 class="font-medium">Brevo</h4>
                    <p>Visit <a href="https://app.brevo.com/settings/keys/api" target="_blank" class="underline">app.brevo.com/settings/keys/api</a></p>
                </div>
                <div>
                    <h4 class="font-medium">Foursquare</h4>
                    <p>Visit <a href="https://developer.foursquare.com/" target="_blank" class="underline">developer.foursquare.com</a></p>
                </div>
            </div>
        </div>
    </div>

    <script>
        function configForm() {
            return {
                loading: false,
                success: false,
                config: {
                    OPENAI_API_KEY: '',
                    TWILIO_ACCOUNT_SID: '',
                    TWILIO_AUTH_TOKEN: '',
                    TWILIO_PHONE_NUMBER: '',
                    AGENT_PHONE_NUMBER: '',
                    BREVO_API_KEY: '',
                    FOURSQUARE_API_KEY: '',
                    MAPTILER_KEY: '',
                    ORS_API_KEY: '',
                    USPS_USER_ID: '',
                    GOOGLE_OAUTH_CLIENT_ID: '',
                    GOOGLE_OAUTH_CLIENT_SECRET: ''
                },
                apiStatus: {
                    openai: false,
                    twilio: false,
                    brevo: false,
                    foursquare: false,
                    maptiler: false,
                    google: false
                },
                
                async init() {
                    await this.loadConfiguration();
                },
                
                async loadConfiguration() {
                    try {
                        const response = await fetch('/api/v1/providers/credentials');
                        if (response.ok) {
                            const data = await response.json();
                            // Populate form with existing credentials
                            Object.keys(this.config).forEach(key => {
                                if (data[key]) {
                                    this.config[key] = '••••••••'; // Show masked values
                                }
                            });
                        }
                    } catch (error) {
                        console.error('Error loading configuration:', error);
                    }
                },
                
                async saveConfiguration() {
                    this.loading = true;
                    this.success = false;
                    
                    try {
                        const response = await fetch('/api/v1/providers/credentials', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(this.config)
                        });
                        
                        if (response.ok) {
                            this.success = true;
                            setTimeout(() => this.success = false, 5000);
                        } else {
                            throw new Error('Failed to save configuration');
                        }
                    } catch (error) {
                        console.error('Error:', error);
                        alert('Sorry, there was an error saving your configuration. Please try again.');
                    } finally {
                        this.loading = false;
                    }
                },
                
                async testAPIs() {
                    try {
                        const response = await fetch('/api/v1/providers/test', {
                            method: 'POST'
                        });
                        
                        if (response.ok) {
                            const results = await response.json();
                            this.apiStatus = results;
                        }
                    } catch (error) {
                        console.error('Error testing APIs:', error);
                    }
                }
            }
        }
    </script>
</body>
</html>