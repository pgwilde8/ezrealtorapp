<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% if agent and agent.buyer_page_headline %}{{ agent.buyer_page_headline }}{% else %}Find Your Dream Home{% endif %} | {% if agent %}{{ agent.name }}{% else %}EZRealtor{% endif %}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Custom Brand Colors -->
    <style>
        :root {
            --primary-color: {% if agent and agent.brand_primary_color %}{{ agent.brand_primary_color }}{% else %}#3B82F6{% endif %};
            --secondary-color: {% if agent and agent.brand_secondary_color %}{{ agent.brand_secondary_color }}{% else %}#1F2937{% endif %};
            --accent-color: {% if agent and agent.brand_accent_color %}{{ agent.brand_accent_color }}{% else %}#10B981{% endif %};
        }
        .btn-primary {
            background-color: var(--primary-color);
        }
        .btn-primary:hover {
            background-color: var(--primary-color);
            opacity: 0.9;
        }
        .text-primary {
            color: var(--primary-color);
        }
        .border-primary {
            border-color: var(--primary-color);
        }
        .focus\:ring-primary:focus {
            --tw-ring-color: var(--primary-color);
        }
        .focus\:border-primary:focus {
            border-color: var(--primary-color);
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        
        <!-- Logo Section -->
        {% if agent and agent.logo_url %}
        <div class="text-center mb-6">
            <img src="{{ agent.logo_url }}" alt="{{ agent.name }} Logo" class="h-16 mx-auto">
        </div>
        {% endif %}
        
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold mb-2" style="color: var(--secondary-color)">
                {% if agent and agent.buyer_page_headline %}
                    {{ agent.buyer_page_headline }}
                {% else %}
                    Find Your Perfect Home
                {% endif %}
            </h1>
            <p class="text-xl text-gray-600 mb-4">
                {% if agent and agent.buyer_page_subtitle %}
                    {{ agent.buyer_page_subtitle }}
                {% else %}
                    Let AI help you discover properties that match your lifestyle
                {% endif %}
            </p>
            
            <!-- Agent Info with Photo -->
            {% if agent %}
            <div class="flex items-center justify-center space-x-4 mb-4">
                {% if agent.headshot_url %}
                <img src="{{ agent.headshot_url }}" alt="{{ agent.name }}" class="w-16 h-16 rounded-full object-cover border-2 border-gray-200">
                {% endif %}
                <div class="text-left">
                    <p class="font-semibold text-lg text-primary">{{ agent.name }}</p>
                    {% if agent.title %}
                    <p class="text-gray-600">{{ agent.title }}</p>
                    {% endif %}
                    {% if agent.brokerage_name %}
                    <p class="text-sm text-gray-500">{{ agent.brokerage_name }}</p>
                    {% endif %}
                    {% if agent.license_number %}
                    <p class="text-xs text-gray-400">License: {{ agent.license_number }}</p>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Lead Capture Form -->
        <div class="max-w-4xl mx-auto bg-white rounded-lg shadow-lg p-8" x-data="buyerForm()">
            
            <!-- Progress Indicator -->
            <div class="mb-8">
                <div class="flex items-center justify-between text-sm text-gray-500">
                    <span :class="step >= 1 ? 'text-primary font-medium' : ''">Contact Info</span>
                    <span :class="step >= 2 ? 'text-primary font-medium' : ''">Property Preferences</span>
                    <span :class="step >= 3 ? 'text-primary font-medium' : ''">AI Analysis</span>
                </div>
                <div class="mt-2 w-full bg-gray-200 rounded-full h-2">
                    <div class="bg-gradient-to-r from-blue-500 to-purple-600 h-2 rounded-full transition-all duration-300" 
                         :style="`width: ${(step / 3) * 100}%`"></div>
                </div>
            </div>

            <form @submit.prevent="submitForm()" class="space-y-6">
                
                <!-- Step 1: Contact Information -->
                <div x-show="step === 1" x-transition class="space-y-6">
                    <div class="text-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-900 mb-2">Let's Get Started</h2>
                        <p class="text-gray-600">First, we'll need some basic information to personalize your experience</p>
                    </div>
                    
                    <div class="grid md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Full Name *</label>
                            <input type="text" x-model="form.full_name" required 
                                   @blur="validateField('full_name')"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-colors">
                            <p x-show="errors.full_name" class="mt-1 text-sm text-red-600" x-text="errors.full_name"></p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Email Address *</label>
                            <input type="email" x-model="form.email" required 
                                   @blur="validateField('email')"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-colors">
                            <p x-show="errors.email" class="mt-1 text-sm text-red-600" x-text="errors.email"></p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Phone Number *</label>
                            <input type="tel" x-model="form.phone" required 
                                   @input="formatPhone()"
                                   @blur="validateField('phone')"
                                   placeholder="(555) 123-4567"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-colors">
                            <p x-show="errors.phone" class="mt-1 text-sm text-red-600" x-text="errors.phone"></p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Best Time to Contact</label>
                            <select x-model="form.contact_preference" 
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary">
                                <option value="">Any time</option>
                                <option value="morning">Morning (8am-12pm)</option>
                                <option value="afternoon">Afternoon (12pm-5pm)</option>
                                <option value="evening">Evening (5pm-8pm)</option>
                                <option value="weekend">Weekends only</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="flex justify-end">
                        <button type="button" @click="nextStep()" 
                                :disabled="!canProceedStep1()"
                                class="btn-primary disabled:bg-gray-400 text-white font-semibold py-3 px-8 rounded-lg transition duration-200">
                            Continue to Preferences ‚Üí
                        </button>
                    </div>
                </div>

                <!-- Step 2: Property Preferences -->
                <div x-show="step === 2" x-transition class="space-y-6">
                    <div class="text-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-900 mb-2">Your Dream Home Details</h2>
                        <p class="text-gray-600">Help us understand what you're looking for</p>
                    </div>
                    
                    <!-- Budget Range with AI Insights -->
                    <div class="bg-blue-50 p-6 rounded-lg">
                        <label class="block text-sm font-medium text-gray-700 mb-3">Budget Range *</label>
                        <select x-model="form.budget_range" required @change="getBudgetInsights()"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary mb-3">
                            <option value="">Select Your Budget</option>
                            <option value="under_300k">Under $300,000</option>
                            <option value="300k_500k">$300,000 - $500,000</option>
                            <option value="500k_750k">$500,000 - $750,000</option>
                            <option value="750k_1m">$750,000 - $1,000,000</option>
                            <option value="1m_1.5m">$1,000,000 - $1,500,000</option>
                            <option value="over_1.5m">Over $1,500,000</option>
                        </select>
                        <div x-show="budgetInsights" x-transition class="text-sm text-blue-700 bg-blue-100 p-3 rounded">
                            <span x-text="budgetInsights"></span>
                        </div>
                    </div>

                    <!-- Property Details -->
                    <div class="grid md:grid-cols-3 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Bedrooms</label>
                            <select x-model="form.bedrooms" 
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary">
                                <option value="">Any</option>
                                <option value="1">1+</option>
                                <option value="2">2+</option>
                                <option value="3">3+</option>
                                <option value="4">4+</option>
                                <option value="5">5+</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Bathrooms</label>
                            <select x-model="form.bathrooms" 
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary">
                                <option value="">Any</option>
                                <option value="1">1+</option>
                                <option value="2">2+</option>
                                <option value="3">3+</option>
                                <option value="4">4+</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Property Type</label>
                            <select x-model="form.property_type" 
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary">
                                <option value="">Any Type</option>
                                <option value="single_family">Single Family Home</option>
                                <option value="condo">Condominium</option>
                                <option value="townhouse">Townhouse</option>
                                <option value="duplex">Duplex</option>
                                <option value="land">Land/Lot</option>
                                <option value="commercial">Commercial</option>
                            </select>
                        </div>
                    </div>

                    <!-- Location with Smart Suggestions -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Preferred Areas/Cities *</label>
                        <textarea x-model="form.preferred_areas" required rows="3" 
                                  @input="getLocationSuggestions()"
                                  placeholder="Enter neighborhoods, cities, zip codes, or landmarks you're interested in..."
                                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary resize-none"></textarea>
                        <div x-show="locationSuggestions.length > 0" class="mt-2">
                            <div class="flex flex-wrap gap-2">
                                <template x-for="suggestion in locationSuggestions" :key="suggestion">
                                    <button type="button" @click="addLocationSuggestion(suggestion)"
                                            class="px-3 py-1 bg-gray-100 text-gray-700 rounded-full text-sm hover:bg-primary hover:text-white transition-colors">
                                        <span x-text="suggestion"></span>
                                    </button>
                                </template>
                            </div>
                        </div>
                    </div>

                    <!-- Timeline with Urgency Detection -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Timeline to Purchase *</label>
                        <select x-model="form.timeline" required @change="getTimelineInsights()"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary">
                            <option value="">Select Timeline</option>
                            <option value="immediately">Ready to buy now (ASAP)</option>
                            <option value="1_month">Within 1 month</option>
                            <option value="1_3_months">1-3 months</option>
                            <option value="3_6_months">3-6 months</option>
                            <option value="6_12_months">6-12 months</option>
                            <option value="over_year">More than a year</option>
                            <option value="just_browsing">Just browsing/researching</option>
                        </select>
                        <div x-show="timelineInsights" x-transition class="mt-2 text-sm text-orange-700 bg-orange-100 p-3 rounded">
                            <span x-text="timelineInsights"></span>
                        </div>
                    </div>

                    <div class="flex justify-between">
                        <button type="button" @click="previousStep()" 
                                class="bg-gray-500 text-white font-semibold py-3 px-8 rounded-lg transition duration-200 hover:bg-gray-600">
                            ‚Üê Back
                        </button>
                        <button type="button" @click="nextStep()" 
                                :disabled="!canProceedStep2()"
                                class="btn-primary disabled:bg-gray-400 text-white font-semibold py-3 px-8 rounded-lg transition duration-200">
                            Continue to AI Analysis ‚Üí
                        </button>
                    </div>
                </div>

                <!-- Step 3: AI Analysis & Priorities -->
                <div x-show="step === 3" x-transition class="space-y-6">
                    <div class="text-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-900 mb-2">AI-Powered Matching</h2>
                        <p class="text-gray-600">Our AI will analyze your responses to find perfect property matches</p>
                    </div>

                    <!-- Lifestyle Priorities -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-4">What matters most to you? (Select all that apply)</label>
                        <div class="grid md:grid-cols-2 gap-3">
                            <template x-for="priority in priorityOptions" :key="priority.value">
                                <label class="flex items-center p-3 border rounded-lg hover:bg-gray-50 cursor-pointer transition-colors"
                                       :class="form.priorities.includes(priority.value) ? 'border-primary bg-blue-50' : 'border-gray-300'">
                                    <input type="checkbox" x-model="form.priorities" :value="priority.value" class="mr-3 text-primary">
                                    <div>
                                        <span class="font-medium" x-text="priority.label"></span>
                                        <p class="text-sm text-gray-600" x-text="priority.description"></p>
                                    </div>
                                </label>
                            </template>
                        </div>
                    </div>

                    <!-- AI Questions -->
                    <div class="space-y-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">What's driving your move? *</label>
                            <textarea x-model="form.motivation" required rows="3" 
                                      placeholder="e.g., new job, growing family, downsizing, investment opportunity..."
                                      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary resize-none"></textarea>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Describe your ideal home and lifestyle</label>
                            <textarea x-model="form.important_features" rows="4" 
                                      placeholder="Tell us about your dream home, must-have features, deal-breakers, or anything else that's important to you..."
                                      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary resize-none"></textarea>
                        </div>

                        <!-- Financing Status -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Financing Status</label>
                            <select x-model="form.financing_status" 
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary">
                                <option value="">Select Status</option>
                                <option value="pre_approved">Pre-approved for mortgage</option>
                                <option value="need_pre_approval">Need pre-approval assistance</option>
                                <option value="cash_buyer">Cash buyer</option>
                                <option value="need_financing_info">Need financing information</option>
                                <option value="first_time_buyer">First-time home buyer</option>
                            </select>
                        </div>
                    </div>

                    <!-- Submit Button -->
                    <div class="pt-6">
                        <div class="flex justify-between">
                            <button type="button" @click="previousStep()" 
                                    class="bg-gray-500 text-white font-semibold py-3 px-8 rounded-lg transition duration-200 hover:bg-gray-600">
                                ‚Üê Back
                            </button>
                            <button type="submit" 
                                    :disabled="loading || !canSubmit()"
                                    class="btn-primary disabled:bg-gray-400 text-white font-semibold py-4 px-12 rounded-lg transition duration-200 relative">
                                <span x-show="!loading" class="flex items-center">
                                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a9 9 0 117.072 0l-.548.547A3.374 3.374 0 0014.846 21H9.154a3.374 3.374 0 00-2.53-1.121l-.548-.547z"></path>
                                    </svg>
                                    {% if agent and agent.submit_button_text %}
                                        {{ agent.submit_button_text }}
                                    {% else %}
                                        Get AI-Powered Property Matches
                                    {% endif %}
                                </span>
                                <span x-show="loading" class="flex items-center">
                                    <svg class="animate-spin w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                    </svg>
                                    AI is analyzing your preferences...
                                </span>
                            </button>
                        </div>
                    </div>
                </div>
            </form>

            <!-- Success Message -->
            <div x-show="success" class="mt-6 p-4 rounded-lg" style="background-color: rgba(16, 185, 129, 0.1); border: 1px solid var(--accent-color); color: var(--accent-color);">
                <h4 class="font-semibold">Thank you for your interest!</h4>
                <p>
                    {% if agent and agent.success_message %}
                        {{ agent.success_message }}
                    {% else %}
                        Our AI is analyzing your preferences and we'll send you personalized property matches within 24 hours.
                    {% endif %}
                </p>
            </div>
        </div>

        <!-- Agent Contact Footer -->
        {% if agent and (agent.website_url or agent.facebook_url or agent.instagram_url or agent.linkedin_url) %}
        <div class="text-center mt-8 pt-8 border-t border-gray-200">
            <p class="text-gray-600 mb-4">Connect with {{ agent.name }}</p>
            <div class="flex justify-center space-x-4">
                {% if agent.website_url %}
                <a href="{{ agent.website_url }}" target="_blank" class="text-gray-500 hover:text-primary transition-colors">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.083 9h1.946c.089-1.546.383-2.97.837-4.118A6.004 6.004 0 004.083 9zM10 2a8 8 0 100 16 8 8 0 000-16zm0 2c-.076 0-.232.032-.465.262-.238.234-.497.623-.737 1.182-.389.907-.673 2.142-.766 3.556h3.936c-.093-1.414-.377-2.649-.766-3.556-.24-.56-.5-.948-.737-1.182C10.232 4.032 10.076 4 10 4zm3.971 5c-.089-1.546-.383-2.97-.837-4.118A6.004 6.004 0 0115.917 9h-1.946zm-2.003 2H8.032c.093 1.414.377 2.649.766 3.556.24.56.5.948.737 1.182.233.23.389.262.465.262.076 0 .232-.032.465-.262.238-.234.498-.623.737-1.182.389-.907.673-2.142.766-3.556zm1.166 4.118c.454-1.147.748-2.572.837-4.118h1.946a6.004 6.004 0 01-2.783 4.118zm-6.268 0C6.412 13.97 6.118 12.546 6.03 11H4.083a6.004 6.004 0 002.783 4.118z" clip-rule="evenodd"></path>
                    </svg>
                    <span class="sr-only">Website</span>
                </a>
                {% endif %}
                {% if agent.facebook_url %}
                <a href="{{ agent.facebook_url }}" target="_blank" class="text-gray-500 hover:text-primary transition-colors">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M20 10c0-5.523-4.477-10-10-10S0 4.477 0 10c0 4.991 3.657 9.128 8.438 9.878v-6.987h-2.54V10h2.54V7.797c0-2.506 1.492-3.89 3.777-3.89 1.094 0 2.238.195 2.238.195v2.46h-1.26c-1.243 0-1.63.771-1.63 1.562V10h2.773l-.443 2.89h-2.33v6.988C16.343 19.128 20 14.991 20 10z" clip-rule="evenodd"></path>
                    </svg>
                    <span class="sr-only">Facebook</span>
                </a>
                {% endif %}
                {% if agent.instagram_url %}
                <a href="{{ agent.instagram_url }}" target="_blank" class="text-gray-500 hover:text-primary transition-colors">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 0C4.477 0 0 4.484 0 10.017c0 4.425 2.865 8.18 6.839 9.504.5.092.682-.217.682-.483 0-.237-.008-.868-.013-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.988 1.029-2.688-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0110 4.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.203 2.398.1 2.651.64.7 1.028 1.595 1.028 2.688 0 3.848-2.339 4.695-4.566 4.942.359.31.678.921.678 1.856 0 1.338-.012 2.419-.012 2.747 0 .268.18.58.688.482A10.019 10.019 0 0020 10.017C20 4.484 15.522 0 10 0z" clip-rule="evenodd"></path>
                    </svg>
                    <span class="sr-only">Instagram</span>
                </a>
                {% endif %}
                {% if agent.linkedin_url %}
                <a href="{{ agent.linkedin_url }}" target="_blank" class="text-gray-500 hover:text-primary transition-colors">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M16.338 16.338H13.67V12.16c0-.995-.017-2.277-1.387-2.277-1.39 0-1.601 1.086-1.601 2.207v4.248H8.014v-8.59h2.559v1.174h.037c.356-.675 1.227-1.387 2.526-1.387 2.703 0 3.203 1.778 3.203 4.092v4.711zM5.005 6.575a1.548 1.548 0 11-.003-3.096 1.548 1.548 0 01.003 3.096zm-1.337 9.763H6.34v-8.59H3.667v8.59zM17.668 1H2.328C1.595 1 1 1.581 1 2.298v15.403C1 18.418 1.595 19 2.328 19h15.34c.734 0 1.332-.582 1.332-1.299V2.298C19 1.581 18.402 1 17.668 1z" clip-rule="evenodd"></path>
                    </svg>
                    <span class="sr-only">LinkedIn</span>
                </a>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>

    <script>
        function buyerForm() {
            return {
                step: 1,
                loading: false,
                success: false,
                errors: {},
                budgetInsights: '',
                timelineInsights: '',
                locationSuggestions: [],
                
                priorityOptions: [
                    { value: 'schools', label: 'School Quality', description: 'Top-rated school districts' },
                    { value: 'commute', label: 'Short Commute', description: 'Easy access to work/downtown' },
                    { value: 'amenities', label: 'Shopping & Dining', description: 'Restaurants, malls, entertainment' },
                    { value: 'parks', label: 'Parks & Recreation', description: 'Outdoor spaces and activities' },
                    { value: 'safety', label: 'Safe Neighborhood', description: 'Low crime rates, family-friendly' },
                    { value: 'walkability', label: 'Walkable Area', description: 'Walk to daily needs' },
                    { value: 'investment', label: 'Investment Potential', description: 'Property value appreciation' },
                    { value: 'quiet', label: 'Quiet Location', description: 'Peaceful, low traffic' },
                    { value: 'modern', label: 'Modern Features', description: 'Updated finishes and technology' },
                    { value: 'space', label: 'Outdoor Space', description: 'Yard, patio, or balcony' }
                ],
                
                form: {
                    full_name: '',
                    email: '',
                    phone: '',
                    contact_preference: '',
                    budget_range: '',
                    bedrooms: '',
                    bathrooms: '',
                    property_type: '',
                    preferred_areas: '',
                    timeline: '',
                    priorities: [],
                    motivation: '',
                    important_features: '',
                    financing_status: '',
                    lead_type: 'buyer_interest'
                },
                
                // Validation methods
                validateField(field) {
                    this.errors[field] = '';
                    
                    switch(field) {
                        case 'full_name':
                            if (!this.form.full_name || this.form.full_name.length < 2) {
                                this.errors.full_name = 'Please enter your full name';
                            }
                            break;
                        case 'email':
                            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                            if (!emailRegex.test(this.form.email)) {
                                this.errors.email = 'Please enter a valid email address';
                            }
                            break;
                        case 'phone':
                            const phoneRegex = /^\(\d{3}\) \d{3}-\d{4}$/;
                            if (!phoneRegex.test(this.form.phone)) {
                                this.errors.phone = 'Please enter a valid phone number';
                            }
                            break;
                    }
                },
                
                // Phone formatting
                formatPhone() {
                    let phone = this.form.phone.replace(/\D/g, '');
                    if (phone.length >= 6) {
                        phone = phone.replace(/(\d{3})(\d{3})(\d{4})/, '($1) $2-$3');
                    } else if (phone.length >= 3) {
                        phone = phone.replace(/(\d{3})(\d{0,3})/, '($1) $2');
                    }
                    this.form.phone = phone;
                },
                
                // Step validation
                canProceedStep1() {
                    return this.form.full_name && 
                           this.form.email && 
                           this.form.phone && 
                           !this.errors.full_name && 
                           !this.errors.email && 
                           !this.errors.phone;
                },
                
                canProceedStep2() {
                    return this.form.budget_range && 
                           this.form.preferred_areas && 
                           this.form.timeline;
                },
                
                canSubmit() {
                    return this.canProceedStep1() && 
                           this.canProceedStep2() && 
                           this.form.motivation;
                },
                
                // Navigation
                nextStep() {
                    if (this.step < 3) {
                        this.step++;
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    }
                },
                
                previousStep() {
                    if (this.step > 1) {
                        this.step--;
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    }
                },
                
                // AI Insights
                getBudgetInsights() {
                    const insights = {
                        'under_300k': 'üí° Great entry-level range! Consider FHA loans for lower down payments.',
                        '300k_500k': 'üè° Popular range with many options. Consider pre-approval to strengthen offers.',
                        '500k_750k': '‚ú® Premium range with luxury features. Competitive market - be ready to act fast.',
                        '750k_1m': 'üè∞ Luxury market. Cash offers often preferred. Consider jumbo loan requirements.',
                        '1m_1.5m': 'üíé High-end luxury. Market moves slower, more room for negotiation.',
                        'over_1.5m': 'üéØ Ultra-luxury segment. Unique properties, longer search process expected.'
                    };
                    this.budgetInsights = insights[this.form.budget_range] || '';
                },
                
                getTimelineInsights() {
                    const insights = {
                        'immediately': 'üö® HOT LEAD! Fast market - pre-approval essential. We can start showings this week.',
                        '1_month': '‚ö° Quick timeline! Let\'s get pre-approved and start searching immediately.',
                        '1_3_months': 'üéØ Perfect timing! Allows for thorough search while staying competitive.',
                        '3_6_months': 'üìÖ Good planning window. Time to explore neighborhoods and get pre-approved.',
                        '6_12_months': 'üß≠ Strategic timeline. We can monitor market trends and prepare.',
                        'over_year': 'üìä Long-term planning. Perfect for market research and preparation.',
                        'just_browsing': 'üîç Early research phase. We can provide market insights and education.'
                    };
                    this.timelineInsights = insights[this.form.timeline] || '';
                },
                
                getLocationSuggestions() {
                    // Simulate AI location suggestions based on input
                    const input = this.form.preferred_areas.toLowerCase();
                    this.locationSuggestions = [];
                    
                    if (input.includes('downtown') || input.includes('city')) {
                        this.locationSuggestions.push('Urban Core', 'Arts District', 'Financial District');
                    }
                    if (input.includes('suburb') || input.includes('quiet')) {
                        this.locationSuggestions.push('Family Neighborhoods', 'Residential Areas', 'Cul-de-sac Streets');
                    }
                    if (input.includes('school') || input.includes('family')) {
                        this.locationSuggestions.push('Top School Districts', 'Family Communities');
                    }
                },
                
                addLocationSuggestion(suggestion) {
                    if (!this.form.preferred_areas.includes(suggestion)) {
                        this.form.preferred_areas += (this.form.preferred_areas ? ', ' : '') + suggestion;
                    }
                    this.locationSuggestions = [];
                },
                
                async submitForm() {
                    this.loading = true;
                    
                    try {
                        // Enhanced form data for AI processing
                        const enhancedFormData = {
                            ...this.form,
                            metadata: {
                                step_completion_time: Date.now(),
                                user_agent: navigator.userAgent,
                                screen_resolution: `${screen.width}x${screen.height}`,
                                priorities: this.form.priorities,
                                preferences: {
                                    budget_range: this.form.budget_range,
                                    bedrooms: this.form.bedrooms,
                                    bathrooms: this.form.bathrooms,
                                    property_type: this.form.property_type,
                                    preferred_areas: this.form.preferred_areas,
                                    timeline: this.form.timeline,
                                    contact_preference: this.form.contact_preference,
                                    financing_status: this.form.financing_status
                                },
                                ai_context: {
                                    motivation: this.form.motivation,
                                    important_features: this.form.important_features,
                                    priorities_selected: this.form.priorities.length,
                                    form_engagement_level: this.calculateEngagementLevel()
                                }
                            }
                        };
                        
                        const response = await fetch('/api/v1/leads/', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(enhancedFormData)
                        });
                        
                        if (response.ok) {
                            const result = await response.json();
                            this.success = true;
                            
                            // Track successful submission
                            if (typeof gtag !== 'undefined') {
                                gtag('event', 'lead_submission', {
                                    'event_category': 'buyer_interest',
                                    'value': this.form.budget_range
                                });
                            }
                            
                            // Reset form
                            this.resetForm();
                        } else {
                            throw new Error('Failed to submit form');
                        }
                    } catch (error) {
                        console.error('Error:', error);
                        alert('Sorry, there was an error submitting your information. Please try again or call us directly.');
                    } finally {
                        this.loading = false;
                    }
                },
                
                calculateEngagementLevel() {
                    let score = 0;
                    
                    // Text field completion
                    if (this.form.preferred_areas && this.form.preferred_areas.length > 20) score += 2;
                    if (this.form.motivation && this.form.motivation.length > 30) score += 2;
                    if (this.form.important_features && this.form.important_features.length > 50) score += 3;
                    
                    // Priority selection
                    score += this.form.priorities.length;
                    
                    // Optional field completion
                    if (this.form.contact_preference) score += 1;
                    if (this.form.financing_status) score += 1;
                    if (this.form.bedrooms) score += 1;
                    if (this.form.bathrooms) score += 1;
                    if (this.form.property_type) score += 1;
                    
                    return Math.min(score, 20); // Cap at 20
                },
                
                resetForm() {
                    this.form = {
                        full_name: '', email: '', phone: '', contact_preference: '',
                        budget_range: '', bedrooms: '', bathrooms: '', property_type: '',
                        preferred_areas: '', timeline: '', priorities: [],
                        motivation: '', important_features: '', financing_status: '',
                        lead_type: 'buyer_interest'
                    };
                    this.step = 1;
                    this.errors = {};
                }
            }
        }
    </script>
</body>
</html>
