<!-- Compact Phone Number Management Component -->

<div x-data="phoneNumberManager()" x-init="init()" class="bg-white rounded-lg shadow mb-6">
    <div class="p-4">
        <!-- Header with Toggle -->
        <div class="flex items-center justify-between cursor-pointer" @click="expanded = !expanded">
            <div class="flex items-center space-x-3">
                <div class="p-2 bg-blue-100 rounded-lg">
                    <i class="fas fa-phone text-blue-600 text-lg"></i>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-gray-900">My Phone Number</h3>
                    <p class="text-xs text-gray-500" x-show="hasPhoneNumber && !loading" x-text="phoneData.phone_number"></p>
                    <p class="text-xs text-gray-500" x-show="!hasPhoneNumber && !loading">No phone number active</p>
                </div>
            </div>
            
            <div class="flex items-center space-x-4">
                <!-- Quick Stats (visible when collapsed) -->
                <div x-show="hasPhoneNumber && !expanded && !loading" class="flex items-center space-x-4 text-sm">
                    <div class="text-center">
                        <div class="text-xs text-gray-500">Calls</div>
                        <div class="font-bold text-gray-900" x-text="stats.total_calls || 0"></div>
                    </div>
                    <div class="text-center">
                        <div class="text-xs text-gray-500">SMS</div>
                        <div class="font-bold text-gray-900" x-text="stats.total_sms || 0"></div>
                    </div>
                    <div class="flex items-center space-x-1">
                        <span class="inline-flex h-2 w-2 rounded-full bg-green-500"></span>
                        <span class="text-xs text-green-600 font-medium">Active</span>
                    </div>
                </div>
                
                <!-- Expand/Collapse Icon -->
                <i class="fas fa-chevron-down text-gray-400 transition-transform" :class="{ 'rotate-180': expanded }"></i>
            </div>
        </div>
        
        <!-- Expanded Content -->
        <div x-show="expanded" 
             x-transition:enter="transition ease-out duration-200"
             x-transition:enter-start="opacity-0 transform -translate-y-2"
             x-transition:enter-end="opacity-100 transform translate-y-0"
             x-transition:leave="transition ease-in duration-150"
             x-transition:leave-start="opacity-100 transform translate-y-0"
             x-transition:leave-end="opacity-0 transform -translate-y-2"
             class="mt-4 pt-4 border-t border-gray-200">
            <!-- Loading State -->
            <div x-show="loading" class="text-center py-6">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"></div>
                <p class="mt-2 text-sm text-gray-600">Loading...</p>
            </div>
            
            <!-- Has Phone Number -->
            <div x-show="!loading && hasPhoneNumber" x-cloak>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div class="bg-blue-50 rounded-lg p-3">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-xs text-gray-600">Calls Received</p>
                                <p class="text-xl font-bold text-gray-900" x-text="stats.total_calls || 0"></p>
                            </div>
                            <i class="fas fa-phone text-blue-600 text-xl"></i>
                        </div>
                    </div>
                    
                    <div class="bg-green-50 rounded-lg p-3">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-xs text-gray-600">Text Messages</p>
                                <p class="text-xl font-bold text-gray-900" x-text="stats.total_sms || 0"></p>
                            </div>
                            <i class="fas fa-sms text-green-600 text-xl"></i>
                        </div>
                    </div>
                    
                    <div class="bg-purple-50 rounded-lg p-3">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-xs text-gray-600">Status</p>
                                <p class="text-sm font-bold text-gray-900 capitalize" x-text="phoneData.status || 'Active'"></p>
                            </div>
                            <i class="fas fa-check-circle text-purple-600 text-xl"></i>
                        </div>
                    </div>
                </div>
                
                <!-- Capabilities & Phone Number -->
                <div class="bg-green-50 border border-green-200 rounded-lg p-3 mb-4">
                    <div class="flex flex-wrap items-center justify-between gap-3">
                        <div>
                            <p class="font-mono text-lg font-bold text-green-800" x-text="phoneData.phone_number"></p>
                            <div class="flex gap-2 mt-1" x-show="phoneData.capabilities">
                                <span x-show="phoneData.capabilities?.voice" class="text-xs px-2 py-0.5 rounded-full bg-blue-100 text-blue-800">Voice</span>
                                <span x-show="phoneData.capabilities?.sms" class="text-xs px-2 py-0.5 rounded-full bg-green-100 text-green-800">SMS</span>
                                <span x-show="phoneData.capabilities?.mms" class="text-xs px-2 py-0.5 rounded-full bg-purple-100 text-purple-800">MMS</span>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button @click="viewCallLog()" class="bg-blue-600 hover:bg-blue-700 text-white text-sm font-semibold py-2 px-4 rounded-lg transition">
                                <i class="fas fa-list mr-1"></i>Call Log
                            </button>
                            <button @click="showReleaseConfirm = true" class="bg-red-600 hover:bg-red-700 text-white text-sm font-semibold py-2 px-4 rounded-lg transition">
                                <i class="fas fa-trash mr-1"></i>Release
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- No Phone Number -->
            <div x-show="!loading && !hasPhoneNumber" x-cloak>
                <!-- For Starter/Growth/Scale/Pro plans -->
                <div x-show="['starter', 'growth', 'scale', 'pro'].includes(agentPlanTier)">
                    <div class="bg-blue-50 rounded-lg p-4 mb-4">
                        <p class="text-sm text-gray-700 mb-3">
                            <i class="fas fa-info-circle text-blue-600 mr-1"></i>
                            Search for an available number in your preferred area code.
                        </p>
                        
                        <div class="flex gap-2">
                            <input 
                                type="text" 
                                x-model="searchAreaCode" 
                                placeholder="Area code (e.g., 716)" 
                                maxlength="3"
                                class="flex-1 px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            >
                            <button 
                                @click="searchNumbers()" 
                                :disabled="searching"
                                class="bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white text-sm font-semibold py-2 px-4 rounded-lg transition whitespace-nowrap"
                            >
                                <i class="fas fa-search mr-1"></i>
                                <span x-show="!searching">Search</span>
                                <span x-show="searching">Searching...</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Available Numbers -->
                    <div x-show="availableNumbers.length > 0" class="space-y-2 max-h-64 overflow-y-auto">
                        <p class="text-xs font-semibold text-gray-700 mb-2">Available Numbers:</p>
                        <template x-for="number in availableNumbers" :key="number.phone_number">
                            <div class="flex items-center justify-between bg-white border border-gray-200 rounded-lg p-3 hover:border-blue-500 transition">
                                <div>
                                    <p class="font-mono text-sm font-semibold" x-text="number.friendly_name"></p>
                                    <p class="text-xs text-gray-600">
                                        <span x-text="number.locality"></span>, <span x-text="number.region"></span>
                                    </p>
                                </div>
                                <button 
                                    @click="purchaseNumber(number.phone_number)" 
                                    class="bg-green-600 hover:bg-green-700 text-white text-xs font-semibold py-1.5 px-3 rounded-lg transition"
                                >
                                    <i class="fas fa-check mr-1"></i>Choose
                                </button>
                            </div>
                        </template>
                    </div>
                </div>
                
                <!-- For Trial plan -->
                <div x-show="agentPlanTier === 'trial'" class="bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg p-4 border-2 border-dashed border-blue-300">
                    <div class="flex items-start space-x-3">
                        <i class="fas fa-lock text-blue-600 text-xl mt-1"></i>
                        <div class="flex-1">
                            <h4 class="font-semibold text-gray-900 mb-1">Get Your Dedicated Phone Number</h4>
                            <p class="text-sm text-gray-600 mb-3">Upgrade to Starter plan to receive calls and text messages from leads</p>
                            <div class="flex flex-wrap gap-2 mb-3">
                                <span class="text-xs px-2 py-1 rounded-full bg-blue-100 text-blue-800">
                                    <i class="fas fa-check mr-1"></i>Voice & IVR
                                </span>
                                <span class="text-xs px-2 py-1 rounded-full bg-green-100 text-green-800">
                                    <i class="fas fa-check mr-1"></i>SMS Messaging
                                </span>
                                <span class="text-xs px-2 py-1 rounded-full bg-purple-100 text-purple-800">
                                    <i class="fas fa-check mr-1"></i>Auto Lead Capture
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Release Confirmation Modal -->
<div x-show="showReleaseConfirm" x-cloak class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" @click.self="showReleaseConfirm = false">
    <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
        <h3 class="text-xl font-bold text-red-600 mb-4">⚠️ Release Phone Number?</h3>
        <p class="text-gray-700 mb-4">
            Are you sure you want to release <strong x-text="phoneData.phone_number"></strong>?
        </p>
        <p class="text-sm text-gray-600 mb-6">
            This action cannot be undone. The number will be returned to Twilio's pool.
        </p>
        <div class="flex gap-3">
            <button 
                @click="showReleaseConfirm = false" 
                class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-lg transition"
            >
                Cancel
            </button>
            <button 
                @click="releaseNumber()" 
                class="flex-1 bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg transition"
            >
                Release Number
            </button>
        </div>
    </div>
</div>

<script>
function phoneNumberManager() {
    return {
        loading: true,
        hasPhoneNumber: false,
        phoneData: {},
        stats: {},
        searchAreaCode: '',
        searching: false,
        availableNumbers: [],
        showReleaseConfirm: false,
        agentPlanTier: '{{ agent.plan_tier if agent else "trial" }}',
        expanded: false, // Start collapsed
        
        async init() {
            await this.loadPhoneNumber();
            await this.loadStats();
            // Auto-expand if no phone number
            if (!this.hasPhoneNumber) {
                this.expanded = true;
            }
        },
        
        async loadPhoneNumber() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/v1/phone-numbers/me', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    this.phoneData = await response.json();
                    this.hasPhoneNumber = !!this.phoneData.phone_number;
                }
            } catch (error) {
                console.error('Error loading phone number:', error);
            } finally {
                this.loading = false;
            }
        },
        
        async loadStats() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/v1/phone-numbers/stats', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    this.stats = data.stats || {};
                }
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        },
        
        async searchNumbers() {
            this.searching = true;
            this.availableNumbers = [];
            
            try {
                const token = localStorage.getItem('token');
                const url = this.searchAreaCode 
                    ? `/api/v1/phone-numbers/search?area_code=${this.searchAreaCode}&limit=10`
                    : `/api/v1/phone-numbers/search?limit=10`;
                    
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    this.availableNumbers = await response.json();
                } else {
                    alert('Error searching for numbers. Please try again.');
                }
            } catch (error) {
                console.error('Error searching numbers:', error);
                alert('Error searching for numbers. Please try again.');
            } finally {
                this.searching = false;
            }
        },
        
        async purchaseNumber(phoneNumber) {
            if (!confirm(`Choose ${phoneNumber} as your phone number?`)) return;
            
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/v1/phone-numbers/purchase', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        phone_number: phoneNumber
                    })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    alert(`🎉 Perfect! ${phoneNumber} is now your dedicated phone number!\n\nLeads can now call and text you at this number.`);
                    await this.loadPhoneNumber();
                    this.availableNumbers = [];
                } else {
                    alert(data.message || 'Unable to activate this number. Please try another one.');
                }
            } catch (error) {
                console.error('Error purchasing number:', error);
                alert('Error purchasing number. Please try again.');
            }
        },
        
        async releaseNumber() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/v1/phone-numbers/me', {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    alert(data.message);
                    this.showReleaseConfirm = false;
                    await this.loadPhoneNumber();
                } else {
                    alert('Failed to release number. Please contact support.');
                }
            } catch (error) {
                console.error('Error releasing number:', error);
                alert('Error releasing number. Please contact support.');
            }
        },
        
        viewCallLog() {
            window.location.href = '/dashboard?tab=leads&filter=phone';
        },
        
        formatDate(dateString) {
            if (!dateString) return '';
            return new Date(dateString).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }
    }
}
</script>

<style>
[x-cloak] { display: none !important; }
.rotate-180 {
    transform: rotate(180deg);
}
</style>
